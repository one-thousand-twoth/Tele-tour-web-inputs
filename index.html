<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Результат игры</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="spectre.min.css">
    <link rel="stylesheet" href="spectre-icons.min.css">
    <style>
        body {
            padding: 0.75rem;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            font-size: 14px;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
        }

        .table-info {
            text-align: center;
            padding: 0.5rem;
            background-color: #f7f8f9;
            border-radius: 0.2rem;
            margin-bottom: 0.75rem;
        }

        .table-info h3 {
            margin: 0;
            color: #5755d9;
            font-size: 1.1rem;
        }

        h4 {
            margin: 0 0 0.5rem 0;
            font-size: 1rem;
        }

        .form-group {
            margin-bottom: 0.75rem;
        }

        .player-card {
            padding: 0.6rem 0.75rem;
            border: 1px solid #dadee4;
            border-radius: 0.2rem;
            margin-bottom: 0.4rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .player-card:hover {
            background-color: #f7f8f9;
        }

        .player-card.selected {
            background-color: var(--tg-theme-button-color, #5755d9);
            color: var(--tg-theme-button-text-color, #ffffff);
            border-color: var(--tg-theme-button-color, #5755d9);
        }

        .player-number {
            font-size: 1.2rem;
            font-weight: bold;
            min-width: 2rem;
        }

        .form-label {
            font-size: 14px;
        }

        .penalty-section {
            margin-top: 0.75rem;
        }

        h5 {
            margin-bottom: 0.4rem;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .form-checkbox {
            display: block;
            margin-bottom: 0.4rem;
            font-size: 14px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="table-info">
            <h3 id="tableNumber">Стол —</h3>
        </div>

        <h4>Результат игры</h4>

        <div class="form-group">
            <div class="player-card" data-player="1">
                <div class="player-number" id="player1Number">#—</div>
                <!-- <div class="form-label">Игрок 1 победил</div> -->
            </div>
            <div class="player-card" data-player="2">
                <div class="player-number" id="player2Number">#—</div>
                <!-- <div class="form-label">Игрок 2 победил</div> -->
            </div>
            <div class="player-card" data-result="draw">
                <div class="form-label">Ничья</div>
            </div>
            <div class="player-card" data-result="underplayed">
                <div class="form-label">Недоиграно</div>
            </div>
        </div>

        <div class="penalty-section">
            <h5>Штрафы</h5>
            <label class="form-checkbox">
                <input type="checkbox" id="penalty1">
                <i class="form-icon"></i> Штраф игроку <span id="penalty1Label">#—</span>
            </label>
            <label class="form-checkbox">
                <input type="checkbox" id="penalty2">
                <i class="form-icon"></i> Штраф игроку <span id="penalty2Label">#—</span>
            </label>
        </div>
    </div>
    <script>
        let selectedWinner = null;
        let tg = null;
        let mainButton = null;

        // Получаем параметры из URL
        const params = new URLSearchParams(window.location.search);
        const player1Id = params.get("proto") || "1";
        const player2Id = params.get("anto") || "2";
        const tableNumber = params.get("table") || "1";

        // Инициализация после загрузки страницы
        window.addEventListener('load', function () {
            // Устанавливаем номера игроков и стола
            document.getElementById('tableNumber').textContent = `Стол ${tableNumber}`;
            document.getElementById('player1Number').textContent = `#${player1Id}`;
            document.getElementById('player2Number').textContent = `#${player2Id}`;
            document.getElementById('penalty1Label').textContent = `#${player1Id}`;
            document.getElementById('penalty2Label').textContent = `#${player2Id}`;

            // Проверяем наличие Telegram WebApp
            if (window.Telegram && window.Telegram.WebApp) {
                tg = window.Telegram.WebApp;
                tg.expand();

                mainButton = tg.MainButton;
                mainButton.text = "Отправить результат";
                mainButton.disable();
                mainButton.show();

                mainButton.onClick(function () {
                    let winner = null;
                    let result = null;

                    if (selectedWinner === 1) {
                        winner = player1Id;
                        state = 'completed';
                    } else if (selectedWinner === 2) {
                        winner = player2Id;
                        state = 'completed';
                    } else {
                        result = selectedWinner;
                        state = selectedWinner;
                    }

                    const data = {
                        table: tableNumber,
                        players: [player1Id, player2Id],
                        state: state,
                        winner: winner,
                        penalties: {
                            player1: document.getElementById('penalty1').checked,
                            player2: document.getElementById('penalty2').checked
                        }
                    };

                    tg.sendData(JSON.stringify(data));
                });

                // Обновляем цвета в соответствии с темой Telegram
                if (tg.themeParams) {
                    document.body.style.backgroundColor = tg.themeParams.bg_color || '#ffffff';
                    document.body.style.color = tg.themeParams.text_color || '#000000';
                }
            } else {
                console.warn('Telegram WebApp не доступен. Приложение работает в режиме предварительного просмотра.');
            }

            // Добавляем обработчики кликов на карточки
            document.querySelectorAll('.player-card').forEach(card => {
                card.addEventListener('click', function () {
                    const player = this.getAttribute('data-player');
                    const result = this.getAttribute('data-result');

                    if (player) {
                        selectWinner(parseInt(player));
                    } else if (result) {
                        selectResult(result);
                    }
                });
            });
        });

        function selectWinner(player) {
            selectedWinner = player;
            document.querySelectorAll('.player-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`.player-card[data-player="${player}"]`).classList.add('selected');
            updateMainButton();
        }

        function selectResult(result) {
            selectedWinner = result;
            document.querySelectorAll('.player-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`.player-card[data-result="${result}"]`).classList.add('selected');
            updateMainButton();
        }

        function updateMainButton() {
            if (mainButton) {
                if (selectedWinner) {
                    mainButton.enable();
                } else {
                    mainButton.disable();
                }
            }
        }
    </script>
</body>

</html>